{% extends 'base.html' %}
{% load static %}
{% block title %}Каталог товаров — АвтоДеталь{% endblock %}
{% block content %}
<h1 class="page-title">Каталог товаров</h1>

<form method="get" class="search-bar">
  <input type="search" name="q" value="{{ query }}" placeholder="Поиск товаров..." aria-label="Поиск">
  <input type="hidden" name="category" value="{{ category_slug }}">
  <input type="hidden" name="sort" value="{{ sort }}">
  <button type="submit" class="btn btn-primary">Найти</button>
  {% if query or category_slug %}<a href="{% url 'products:catalog' %}" class="btn btn-secondary">Сбросить</a>{% endif %}
</form>

{% if categories %}
<p class="filter-categories">
  <strong>Категории:</strong>
  <a href="{% url 'products:catalog' %}{% if query %}?q={{ query|urlencode }}&sort={{ sort }}{% endif %}" class="{% if not category_slug %}active{% endif %}">Все категории</a>
  {% for cat in categories %}
  <a href="{% url 'products:catalog' %}?category={{ cat.slug }}{% if query %}&q={{ query|urlencode }}{% endif %}&sort={{ sort }}" class="{% if category_slug == cat.slug %}active{% endif %}">{{ cat.name }}</a>
  {% endfor %}
</p>
{% endif %}

<div class="catalog-toolbar d-flex flex-wrap align-items-center gap-2 mb-3">
  <label class="mb-0">Сортировка:</label>
  <form method="get" class="d-flex align-items-center gap-1" id="sort-form">
    <input type="hidden" name="q" value="{{ query }}">
    <input type="hidden" name="category" value="{{ category_slug }}">
    <select name="sort" class="form-select form-select-sm" style="width: auto;" onchange="this.form.submit()">
      <option value="name" {% if sort == 'name' %}selected{% endif %}>По названию</option>
      <option value="price_asc" {% if sort == 'price_asc' %}selected{% endif %}>По цене — по возрастанию</option>
      <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>По цене — по убыванию</option>
    </select>
  </form>
</div>

<table class="catalog-table">
  <thead>
    <tr>
      <th class="col-article">Артикул</th>
      <th class="col-image">Изображение</th>
      <th class="col-name">Наименование</th>
      <th class="col-desc">Описание</th>
      <th class="col-availability">Наличие</th>
      <th class="col-delivery">Срок доставки</th>
      <th class="col-price">Цена</th>
      <th class="col-actions">Действия</th>
    </tr>
  </thead>
  <tbody>
    {% for product in products %}
    <tr>
      <td class="col-article">{{ product.article|default:product.id }}</td>
      <td class="col-image">
        {% if product.image %}
        <img src="{{ product.image.url }}" alt="{{ product.name }}" width="56" height="56">
        {% else %}
        <img src="https://placehold.co/56x56/e5e7eb/6b7280?text={{ product.article|default:'—' }}" alt="" width="56" height="56">
        {% endif %}
      </td>
      <td class="col-name"><a href="{{ product.get_absolute_url }}">{{ product.name }}</a></td>
      <td class="col-desc">{{ product.description|truncatewords:20 }}</td>
      <td class="col-availability">
        {% if product.in_stock %}
        <span class="availability-in">В наличии</span>
        {% else %}
        <span class="availability-order">Под заказ</span>
        {% endif %}
      </td>
      <td class="col-delivery">{% if product.delivery_days %}{{ product.delivery_days }}{% else %}—{% endif %}</td>
      <td class="col-price">{{ product.price }} Р</td>
      <td class="col-actions">
        <form method="post" action="{% url 'cart:add_to_cart' %}" class="add-to-cart-form">
          {% csrf_token %}
          <input type="hidden" name="product_id" value="{{ product.id }}">
          <div class="qty-control">
            <button type="button" class="qty-minus" aria-label="Уменьшить">−</button>
            <input type="number" name="quantity" value="1" min="1" max="99" aria-label="Количество">
            <button type="button" class="qty-plus" aria-label="Увеличить">+</button>
          </div>
          <button type="submit" class="btn btn-primary add-to-cart-btn">В корзину</button>
        </form>
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="9" class="text-center py-4">Товаров не найдено.</td></tr>
    {% endfor %}
  </tbody>
</table>

{% if products.has_other_pages %}
<nav class="mt-4" aria-label="Пагинация каталога">
  <ul class="pagination justify-content-center flex-wrap">
    {% if products.has_previous %}
    <li class="page-item"><a class="page-link" href="?page={{ products.previous_page_number }}{% if query %}&q={{ query|urlencode }}{% endif %}{% if category_slug %}&category={{ category_slug }}{% endif %}&sort={{ sort }}">« Назад</a></li>
    {% endif %}
    {% for num in products.paginator.page_range %}
      {% if products.number == num %}
    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
      {% else %}
    <li class="page-item"><a class="page-link" href="?page={{ num }}{% if query %}&q={{ query|urlencode }}{% endif %}{% if category_slug %}&category={{ category_slug }}{% endif %}&sort={{ sort }}">{{ num }}</a></li>
      {% endif %}
    {% endfor %}
    {% if products.has_next %}
    <li class="page-item"><a class="page-link" href="?page={{ products.next_page_number }}{% if query %}&q={{ query|urlencode }}{% endif %}{% if category_slug %}&category={{ category_slug }}{% endif %}&sort={{ sort }}">Вперед »</a></li>
    {% endif %}
  </ul>
</nav>
{% endif %}
{% endblock %}
